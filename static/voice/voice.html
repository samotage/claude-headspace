<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0d1117">
  <title>Claude Chat</title>
  <link rel="manifest" href="/static/voice/manifest.json">
  <link rel="apple-touch-icon" href="/static/voice/icons/icon-192.png">
  <link rel="stylesheet" href="/static/voice/voice.css">
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <a href="/voice" class="app-title" id="app-title-link"><pre class="app-ascii" aria-label="CLAUDE"> ██████╗██╗      █████╗ ██╗   ██╗██████╗ ███████╗
██╔════╝██║     ██╔══██╗██║   ██║██╔══██╗██╔════╝
██║     ██║     ███████║██║   ██║██║  ██║█████╗
██║     ██║     ██╔══██║██║   ██║██║  ██║██╔══╝
╚██████╗███████╗██║  ██║╚██████╔╝██████╔╝███████╗
 ╚═════╝╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚══════╝</pre><span class="app-brand-cursor">&gt;_</span><span class="app-brand-suffix">chat</span></a>
    <div class="header-actions">
      <span id="connection-status" class="connection-dot disconnected"></span>
      <button id="settings-btn" class="icon-btn" aria-label="Settings">&#9881;</button>
      <a href="/" class="close-btn" aria-label="Close and return to dashboard">&times;</a>
    </div>
  </header>

  <!-- Screen: Setup (first-launch) -->
  <div id="screen-setup" class="screen active">
    <div class="setup-title">Claude Chat</div>
    <div class="setup-subtitle">Connect to your Claude Headspace server</div>
    <form id="setup-form">
      <div class="form-group">
        <label for="setup-url">Server URL</label>
        <input type="url" id="setup-url" placeholder="http://192.168.1.x:5055" required>
      </div>
      <div class="form-group">
        <label for="setup-token">Authentication Token</label>
        <input type="password" id="setup-token" placeholder="Enter your token" required>
      </div>
      <button type="submit" class="btn-primary">Connect</button>
    </form>
  </div>

  <!-- Screen: Agent List -->
  <div id="screen-agents" class="screen">
    <div id="agent-list"></div>
    <div id="agent-status-message" class="agent-status-message"></div>
    <!-- Floating mic button -->
    <div style="text-align:center; margin-top:24px;">
      <button id="mic-btn" aria-label="Start listening">&#127908;</button>
    </div>
  </div>

  <!-- Screen: Listening / Command -->
  <div id="screen-listening" class="screen">
    <div class="screen-header">
      <button class="back-btn">&larr; Back</button>
    </div>
    <div class="listening-target">Sending to: <strong id="listening-target">—</strong></div>
    <div id="live-transcript"></div>
    <div id="status-message"></div>
    <!-- Text input fallback -->
    <form id="text-form" class="text-fallback">
      <input type="text" id="text-input" placeholder="Type a command..." autocomplete="off">
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- Screen: Question / Response -->
  <div id="screen-question" class="screen">
    <div class="screen-header">
      <button class="back-btn">&larr; Back</button>
      <h2>Agent Question</h2>
    </div>
    <div id="question-text"></div>
    <div id="question-options"></div>
    <div id="question-free">
      <form id="question-free-form" class="text-fallback">
        <input type="text" id="question-free-input" placeholder="Type your answer..." autocomplete="off">
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <!-- Screen: Chat Transcript -->
  <div id="screen-chat" class="screen">
    <div class="chat-header">
      <button class="chat-back-btn" aria-label="Back">&larr;</button>
      <span id="chat-hero" class="chat-hero-badge"></span>
      <div class="chat-header-info">
        <span id="chat-agent-name" class="chat-agent-name"></span>
        <span id="chat-project-name" class="chat-project-name"></span>
      </div>
    </div>
    <div id="attention-banners" class="attention-banners"></div>
    <!-- Drop zone overlay -->
    <div id="chat-drop-zone" class="chat-drop-zone" style="display:none">
      <div class="drop-zone-content">
        <div class="drop-zone-icon">&#128206;</div>
        <div class="drop-zone-text">Drop file to share</div>
      </div>
    </div>
    <div id="chat-messages" class="chat-messages">
      <div id="chat-load-more" class="chat-load-more" style="display:none"></div>
    </div>
    <div id="chat-typing" class="chat-typing" style="display:none">
      <div class="typing-bubble">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>
    <div id="chat-ended-banner" class="chat-ended-banner" style="display:none">
      Agent session has ended
    </div>
    <div id="chat-input-area" class="chat-input-bar">
      <!-- Pending attachment preview -->
      <div id="chat-attachment-preview" class="chat-attachment-preview" style="display:none">
        <div id="attachment-thumb" class="attachment-thumb"></div>
        <div id="attachment-info" class="attachment-info">
          <span id="attachment-name" class="attachment-name"></span>
          <span id="attachment-size" class="attachment-size"></span>
        </div>
        <button type="button" id="attachment-remove" class="attachment-remove" aria-label="Remove attachment">&times;</button>
      </div>
      <!-- Upload progress bar -->
      <div id="chat-upload-progress" class="chat-upload-progress" style="display:none">
        <div id="chat-upload-bar" class="chat-upload-bar"></div>
      </div>
      <!-- Upload error toast -->
      <div id="chat-upload-error" class="chat-upload-error" style="display:none"></div>
      <form id="chat-input-form" class="chat-input-form">
        <textarea id="chat-text-input" class="chat-text-field" placeholder="Message..." autocomplete="off" rows="1"></textarea>
        <button type="submit" id="chat-send-btn" class="chat-send-btn" aria-label="Send">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor"/></svg>
        </button>
        <button type="button" id="chat-mic-btn" class="chat-mic-btn" aria-label="Voice input">&#127908;</button>
      </form>
    </div>
  </div>

  <!-- Screen: Settings -->
  <div id="screen-settings" class="screen">
    <div class="screen-header">
      <button class="settings-back-btn">&larr; Back</button>
      <h2>Settings</h2>
    </div>
    <form id="settings-form">
      <div class="settings-section">
        <h3>Display</h3>
        <div class="setting-row">
          <span class="setting-label">Font size</span>
          <span class="setting-control"><input type="range" id="setting-fontsize" min="13" max="20" step="1"> <span id="fontsize-value" class="setting-value">15px</span></span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Verbosity</span>
          <select id="setting-verbosity">
            <option value="brief">Brief</option>
            <option value="normal" selected>Normal</option>
            <option value="full">Full</option>
          </select>
        </div>
      </div>

      <div class="settings-section">
        <h3>Voice Input</h3>
        <div class="setting-row">
          <span class="setting-label">Silence timeout</span>
          <span class="setting-control"><input type="range" id="setting-silence" min="600" max="1200" step="50"> <span id="silence-value" class="setting-value">800ms</span></span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Done word</span>
          <select id="setting-doneword">
            <option value="send">send</option>
            <option value="over">over</option>
            <option value="done">done</option>
          </select>
        </div>
        <div class="setting-row">
          <span class="setting-label">Auto-target agent</span>
          <label class="toggle"><input type="checkbox" id="setting-autotarget"><span class="toggle-track"></span></label>
        </div>
      </div>

      <div class="settings-section">
        <h3>Voice Output</h3>
        <div class="setting-row">
          <span class="setting-label">Text-to-speech</span>
          <label class="toggle"><input type="checkbox" id="setting-tts" checked><span class="toggle-track"></span></label>
        </div>
        <div class="setting-row">
          <span class="setting-label">Audio cues</span>
          <label class="toggle"><input type="checkbox" id="setting-cues" checked><span class="toggle-track"></span></label>
        </div>
      </div>

      <div class="settings-section">
        <h3>Connection</h3>
        <div class="setting-row">
          <span class="setting-label">Server URL</span>
          <input type="text" id="setting-url">
        </div>
        <div class="setting-row">
          <span class="setting-label">Token</span>
          <input type="password" id="setting-token">
        </div>
      </div>

      <button type="submit" class="btn-primary">Save Settings</button>
    </form>
  </div>

  <!-- Scripts -->
  <script src="/static/voice/voice-api.js?v=2"></script>
  <script src="/static/voice/voice-input.js?v=2"></script>
  <script src="/static/voice/voice-output.js?v=2"></script>
  <script src="/static/voice/voice-app.js?v=2"></script>
  <script>
    // Trusted network: inject credentials into localStorage before init() runs.
    // This is cache-proof — even if voice-app.js is served from browser cache,
    // loadSettings() will find these credentials and skip the setup screen.
    (function () {
      var h = location.hostname;
      var isLocal = (h === 'localhost' || h === '127.0.0.1' || h === '::1');
      var isLAN = /^(10\.|172\.(1[6-9]|2\d|3[01])\.|192\.168\.|100\.)/.test(h);
      var isTailscaleDNS = /\.ts\.net$/.test(h);
      if (isLocal || isLAN || isTailscaleDNS) {
        try {
          var stored = JSON.parse(localStorage.getItem('voice_settings') || '{}');
          if (!stored.serverUrl || !stored.token) {
            stored.serverUrl = location.origin;
            stored.token = isLocal ? 'localhost' : 'lan';
            localStorage.setItem('voice_settings', JSON.stringify(stored));
          }
        } catch (e) { /* ignore */ }
      }
    })();

    document.addEventListener('DOMContentLoaded', function () {
      VoiceApp.bindEvents();
      VoiceApp.init();
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/voice-sw.js', { scope: '/voice' })
        .catch(function () { /* ignore */ });
    }
  </script>

</body>
</html>
