<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0d1117">
  <title>Claude Chat</title>
  <!-- Apply theme before first paint to prevent flash -->
  <script>
    (function () {
      try {
        var s = JSON.parse(localStorage.getItem('voice_settings') || '{}');
        var t = s.theme || 'dark';
        if (t !== 'dark') document.documentElement.setAttribute('data-theme', t);
        var colors = { dark: '#0d1117', warm: '#f5f0e8', cool: '#fbfaf8' };
        var meta = document.querySelector('meta[name="theme-color"]');
        if (meta && colors[t]) meta.setAttribute('content', colors[t]);
      } catch (e) {}
    })();
  </script>
  <link rel="manifest" href="/static/voice/manifest.json">
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/voice/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/voice/icons/favicon-16x16.png">
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/voice/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-title" content="Claude Chat">
  <link rel="stylesheet" href="/static/voice/voice.css">
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <a href="/voice" class="app-title" id="app-title-link"><pre class="app-ascii" aria-label="CLAUDE"> ██████╗██╗      █████╗ ██╗   ██╗██████╗ ███████╗
██╔════╝██║     ██╔══██╗██║   ██║██╔══██╗██╔════╝
██║     ██║     ███████║██║   ██║██║  ██║█████╗
██║     ██║     ██╔══██║██║   ██║██║  ██║██╔══╝
╚██████╗███████╗██║  ██║╚██████╔╝██████╔╝███████╗
 ╚═════╝╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚══════╝</pre><span class="app-brand-cursor">&gt;_</span><span class="app-brand-suffix">chat</span></a>
    <div class="header-actions">
      <span id="connection-status" class="connection-dot disconnected"></span>
      <button id="hamburger-btn" class="hamburger-btn" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      </button>
    </div>
  </header>

  <!-- Hamburger dropdown (stacked/narrow mode) -->
  <div id="hamburger-backdrop" class="hamburger-backdrop"></div>
  <div id="hamburger-dropdown" class="hamburger-dropdown">
    <button class="hamburger-item" data-action="new-chat">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      <span>New Chat</span>
    </button>
    <button class="hamburger-item" data-action="settings">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="2.5" stroke="currentColor" stroke-width="1.4"/><path d="M8 1.5v2M8 12.5v2M1.5 8h2M12.5 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
      <span>Settings</span>
    </button>
    <button class="hamburger-item" data-action="close">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      <span>Close</span>
    </button>
  </div>

  <!-- Screen: Setup (first-launch, full screen, outside app-layout) -->
  <div id="screen-setup" class="screen active">
    <div class="setup-title">Claude Chat</div>
    <div class="setup-subtitle">Connect to your Claude Headspace server</div>
    <form id="setup-form">
      <div class="form-group">
        <label for="setup-url">Server URL</label>
        <input type="url" id="setup-url" placeholder="http://192.168.1.x:5055" required>
      </div>
      <div class="form-group">
        <label for="setup-token">Authentication Token</label>
        <input type="password" id="setup-token" placeholder="Enter your token" required>
      </div>
      <button type="submit" class="btn-primary">Connect</button>
    </form>
  </div>

  <!-- Split-panel layout wrapper -->
  <div id="app-layout">
    <!-- Left: sidebar (agent list) -->
    <aside id="sidebar">
      <div id="agent-list"></div>
      <div id="agent-status-message" class="agent-status-message"></div>
      <div style="text-align:center; margin-top:24px; flex-shrink:0;">
        <button id="mic-btn" aria-label="Start listening">&#127908;</button>
      </div>
      <!-- FAB (split/wide mode) -->
      <div id="fab-container" class="fab-container">
        <div id="fab-backdrop" class="fab-backdrop"></div>
        <div class="fab-menu">
          <button class="fab-menu-item" data-action="close" aria-label="Close">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
            <span>Close</span>
          </button>
          <button class="fab-menu-item" data-action="settings" aria-label="Settings">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="2.5" stroke="currentColor" stroke-width="1.4"/><path d="M8 1.5v2M8 12.5v2M1.5 8h2M12.5 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
            <span>Settings</span>
          </button>
          <button class="fab-menu-item fab-item-new-chat" data-action="new-chat" aria-label="New Chat">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
            <span>New Chat</span>
          </button>
        </div>
        <button id="fab-btn" class="fab-btn" aria-label="Actions">
          <svg class="fab-icon" width="22" height="22" viewBox="0 0 22 22" fill="none"><path d="M11 4v14M4 11h14" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/></svg>
        </button>
      </div>
    </aside>

    <!-- Right: main panel -->
    <main id="main-panel">
      <!-- Screen: Listening / Command -->
      <div id="screen-listening" class="screen">
        <div class="screen-header">
          <button class="back-btn">&larr; Back</button>
        </div>
        <div class="listening-target">Sending to: <strong id="listening-target">—</strong></div>
        <div id="live-transcript"></div>
        <div id="status-message"></div>
        <form id="text-form" class="text-fallback">
          <input type="text" id="text-input" placeholder="Type a command..." autocomplete="off">
          <button type="submit">Send</button>
        </form>
      </div>

      <!-- Screen: Question / Response -->
      <div id="screen-question" class="screen">
        <div class="screen-header">
          <button class="back-btn">&larr; Back</button>
          <h2>Agent Question</h2>
        </div>
        <div id="question-text"></div>
        <div id="question-options"></div>
        <div id="question-free">
          <form id="question-free-form" class="text-fallback">
            <input type="text" id="question-free-input" placeholder="Type your answer..." autocomplete="off">
            <button type="submit">Send</button>
          </form>
        </div>
      </div>

      <!-- Screen: Chat Transcript -->
      <div id="screen-chat" class="screen">
        <div class="chat-header">
          <button class="chat-back-btn" aria-label="Back">&larr;</button>
          <div id="chat-focus-link" class="chat-focus-link" role="button" tabindex="0" title="Focus iTerm window">
            <span id="chat-hero" class="chat-hero-badge"></span>
            <div class="chat-header-info">
              <span id="chat-agent-name" class="chat-agent-name"></span>
              <span id="chat-project-name" class="chat-project-name"></span>
              <span id="chat-task-instruction" class="chat-task-instruction"></span>
            </div>
          </div>
          <span id="chat-state-pill" class="chat-state-pill"></span>
        </div>
        <div id="attention-banners" class="attention-banners"></div>
        <!-- Drop zone overlay -->
        <div id="chat-drop-zone" class="chat-drop-zone" style="display:none">
          <div class="drop-zone-content">
            <div class="drop-zone-icon">&#128206;</div>
            <div class="drop-zone-text">Drop file to share</div>
          </div>
        </div>
        <div id="chat-messages" class="chat-messages">
          <div id="chat-load-more" class="chat-load-more" style="display:none"></div>
        </div>
        <div id="chat-typing" class="chat-typing" style="display:none">
          <div class="typing-bubble">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
        <div id="chat-ended-banner" class="chat-ended-banner" style="display:none">
          Agent session has ended
        </div>
        <div id="chat-input-area" class="chat-input-bar">
          <!-- Pending attachment preview -->
          <div id="chat-attachment-preview" class="chat-attachment-preview" style="display:none">
            <div id="attachment-thumb" class="attachment-thumb"></div>
            <div id="attachment-info" class="attachment-info">
              <span id="attachment-name" class="attachment-name"></span>
              <span id="attachment-size" class="attachment-size"></span>
            </div>
            <button type="button" id="attachment-remove" class="attachment-remove" aria-label="Remove attachment">&times;</button>
          </div>
          <!-- Upload progress bar -->
          <div id="chat-upload-progress" class="chat-upload-progress" style="display:none">
            <div id="chat-upload-bar" class="chat-upload-bar"></div>
          </div>
          <!-- Upload error toast -->
          <div id="chat-upload-error" class="chat-upload-error" style="display:none"></div>
          <form id="chat-input-form" class="chat-input-form">
            <input type="file" id="chat-file-input" accept="image/*,.pdf,.txt,.md,.py,.js,.ts,.json,.yaml,.yml,.html,.css,.rb,.sh,.sql,.csv,.log" style="display:none">
            <button type="button" id="chat-attach-btn" class="chat-attach-btn" aria-label="Attach file">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
            </button>
            <textarea id="chat-text-input" class="chat-text-field" placeholder="Message..." autocomplete="off" rows="1"></textarea>
            <button type="submit" id="chat-send-btn" class="chat-send-btn" aria-label="Send">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor"/></svg>
            </button>
            <button type="button" id="chat-mic-btn" class="chat-mic-btn" aria-label="Voice input">&#127908;</button>
          </form>
        </div>
      </div>

      <!-- Empty state: shown in split mode when no agent selected -->
      <div id="main-panel-empty" class="main-panel-empty">
        <div class="empty-state">Select an agent to start chatting</div>
      </div>
    </main>
  </div>

  <!-- Settings slide-out panel (outside app-layout) -->
  <div id="settings-overlay" class="settings-overlay"></div>
  <div id="settings-panel" class="settings-panel">
    <div class="settings-panel-header">
      <h2>Settings</h2>
      <button id="settings-close-btn" class="settings-close-btn" aria-label="Close">&times;</button>
    </div>
    <form id="settings-form">
      <div class="settings-section">
        <h3>Display</h3>
        <div class="setting-row" style="flex-direction:column;align-items:stretch;gap:4px">
          <span class="setting-label">Theme</span>
          <div id="theme-selector" class="theme-selector">
            <button type="button" class="theme-chip active" data-theme="dark">
              <div class="theme-chip-swatch"><div class="theme-chip-swatch-bg"></div><div class="theme-chip-swatch-surface"></div></div>
              <span class="theme-chip-label">Dark</span>
            </button>
            <button type="button" class="theme-chip" data-theme="warm">
              <div class="theme-chip-swatch"><div class="theme-chip-swatch-bg"></div><div class="theme-chip-swatch-surface"></div></div>
              <span class="theme-chip-label">Warm</span>
            </button>
            <button type="button" class="theme-chip" data-theme="cool">
              <div class="theme-chip-swatch"><div class="theme-chip-swatch-bg"></div><div class="theme-chip-swatch-surface"></div></div>
              <span class="theme-chip-label">Cool</span>
            </button>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Font size</span>
          <span class="setting-control"><input type="range" id="setting-fontsize" min="13" max="20" step="1"> <span id="fontsize-value" class="setting-value">15px</span></span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Verbosity</span>
          <select id="setting-verbosity">
            <option value="brief">Brief</option>
            <option value="normal" selected>Normal</option>
            <option value="full">Full</option>
          </select>
        </div>
      </div>

      <div class="settings-section">
        <h3>Voice Input</h3>
        <div class="setting-row">
          <span class="setting-label">Silence timeout</span>
          <span class="setting-control"><input type="range" id="setting-silence" min="600" max="1200" step="50"> <span id="silence-value" class="setting-value">800ms</span></span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Done word</span>
          <select id="setting-doneword">
            <option value="send">send</option>
            <option value="over">over</option>
            <option value="done">done</option>
          </select>
        </div>
        <div class="setting-row">
          <span class="setting-label">Auto-target agent</span>
          <label class="toggle"><input type="checkbox" id="setting-autotarget"><span class="toggle-track"></span></label>
        </div>
      </div>

      <div class="settings-section">
        <h3>Voice Output</h3>
        <div class="setting-row">
          <span class="setting-label">Text-to-speech</span>
          <label class="toggle"><input type="checkbox" id="setting-tts" checked><span class="toggle-track"></span></label>
        </div>
        <div class="setting-row">
          <span class="setting-label">Audio cues</span>
          <label class="toggle"><input type="checkbox" id="setting-cues" checked><span class="toggle-track"></span></label>
        </div>
      </div>

      <div class="settings-section">
        <h3>Connection</h3>
        <div class="setting-row">
          <span class="setting-label">Server URL</span>
          <input type="text" id="setting-url">
        </div>
        <div class="setting-row">
          <span class="setting-label">Token</span>
          <input type="password" id="setting-token">
        </div>
      </div>

      <button type="submit" class="btn-primary">Save Settings</button>
    </form>
  </div>

  <!-- Scripts -->
  <script src="/static/js/utils.js?v=4"></script>
  <script src="/static/js/confirm-dialog.js?v=4"></script>
  <script src="/static/voice/voice-api.js?v=6"></script>
  <script src="/static/voice/voice-input.js?v=5"></script>
  <script src="/static/voice/voice-output.js?v=5"></script>
  <script src="/static/voice/voice-app.js?v=6"></script>
  <script>
    // Trusted network: inject credentials into localStorage before init() runs.
    // This is cache-proof — even if voice-app.js is served from browser cache,
    // loadSettings() will find these credentials and skip the setup screen.
    (function () {
      var h = location.hostname;
      var isLocal = (h === 'localhost' || h === '127.0.0.1' || h === '::1');
      var isLAN = /^(10\.|172\.(1[6-9]|2\d|3[01])\.|192\.168\.|100\.)/.test(h);
      var isTailscaleDNS = /\.ts\.net$/.test(h);
      if (isLocal || isLAN || isTailscaleDNS) {
        try {
          var stored = JSON.parse(localStorage.getItem('voice_settings') || '{}');
          if (!stored.serverUrl || !stored.token) {
            stored.serverUrl = location.origin;
            stored.token = isLocal ? 'localhost' : 'lan';
            localStorage.setItem('voice_settings', JSON.stringify(stored));
          }
        } catch (e) { /* ignore */ }
      }
    })();

    document.addEventListener('DOMContentLoaded', function () {
      VoiceApp.bindEvents();
      VoiceApp.init();
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/voice-sw.js', { scope: '/voice' })
        .catch(function () { /* ignore */ });
    }
  </script>

  <!-- Project Picker Bottom Sheet -->
  <div id="project-picker-backdrop" class="project-picker-backdrop"></div>
  <div id="project-picker" class="project-picker">
    <div class="project-picker-header">
      <h2>New Chat</h2>
      <button id="project-picker-close" class="settings-close-btn" aria-label="Close">&times;</button>
    </div>
    <div class="project-picker-search-wrap">
      <input type="text" id="project-picker-search" class="project-picker-search" placeholder="Search projects..." autocomplete="off">
    </div>
    <div id="project-picker-list" class="project-picker-list"></div>
  </div>

  <!-- Image Lightbox Modal -->
  <div id="image-lightbox" class="image-lightbox" style="display:none">
    <div class="image-lightbox-backdrop"></div>
    <div class="image-lightbox-content">
      <button class="image-lightbox-close" aria-label="Close image">&times;</button>
      <img id="lightbox-img" src="" alt="">
    </div>
  </div>

</body>
</html>
