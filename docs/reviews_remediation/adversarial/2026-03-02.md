# Adversarial Code Review — 2026-03-02

## Review Scope
- **Window:** Since last review (2026-02-28, tag `adversarial-review/last`)
- **Files in original scope:** 46
- **Comparison point:** `bff3dec`

## Pass 1 — First Coat
- **Lint issues auto-fixed:** 0 (ruff/pre-commit not installed; manual checks clean)
- **Review issues found:** 4 (Security: 1, Performance: 0, Error Handling: 1, Code Quality: 1, Test Quality: 0, Architecture: 1)
- **Fixes applied:** 4
- **Tests:** 78 tests run (test_advisory_lock, test_hooks, test_agents), 1 test updated to match corrected behavior, all passing

### Findings & Fixes
| # | Severity | Category | File | Description | Fix |
|---|----------|----------|------|-------------|-----|
| 1 | LOW | Security | `advisory_lock.py:108-110` | SQL f-string for SET lock_timeout lacked explicit type/range guard | Added `isinstance` + negative check before f-string |
| 2 | HIGH | Error Handling | `hooks.py:50-58` | Rate limiter deleted IP key after pruning stale timestamps, returning True without recording the current request | Removed early-return-on-empty-list; always record timestamp |
| 3 | MEDIUM | Architecture | `agents.py:190` | Deprecated dummy lock (`get_reconcile_lock()`) providing false concurrency protection | Replaced with real `advisory_lock_or_skip` + 409 response |
| 4 | MEDIUM | Code Quality | `hook_deferred_stop.py` | 6 helper functions copy-pasted from `hook_receiver.py` (~90 lines of duplication) | Replaced with imports from canonical source |

## Pass 2 — Second Coat
- **Lint issues auto-fixed:** 0
- **Review issues found:** 4 (Security: 1, Error Handling: 1, Code Quality: 1, Test Quality: 1)
- **Fixes applied:** 4
- **Tests:** 149 tests run (added test_voice_bridge, test_hook_receiver), all passing

### Pass 1 Fix Verification
- 4 fixes verified correct
- 0 fixes required rework

### Findings & Fixes
| # | Severity | Category | File | Description | Fix |
|---|----------|----------|------|-------------|-----|
| 5 | MEDIUM | Security | `voice_bridge.py:246` | `_is_local_or_lan` treated all `100.x.y.z` as Tailscale CGNAT; only `100.64-127.x.x` is the actual range. Public IPs in `100.0-63.x.x` and `100.128-255.x.x` bypassed voice auth | Added second-octet range check (64 <= n <= 127) |
| 6 | MEDIUM | Error Handling | `config_editor.py:624` | `except Exception:` without `as e` — `type(Exception).__name__` always evaluates to `"type"`, making error messages useless | Added `as e` to capture actual exception |
| 7 | LOW | Code Quality | `voice_bridge.py:64` | Negative pattern matching used substring `in` — `"no" in "know"` is True, `"no" in "acknowledge"` is True | Switched to word-boundary matching via `set.split()` intersection |
| 8 | MEDIUM | Test Quality | `test_voice_bridge.py` | Two tests had incomplete mocks (missing `.state` attribute causing MagicMock serialization failures) + wrong assertion (expected non-existent stale filtering) | Fixed mocks, corrected assertions, patched `_agent_to_voice_dict` |

## Pass 3 — Final Coat
- **Lint issues auto-fixed:** 0
- **Review issues found:** 1 (Code Quality: 1)
- **Fixes applied:** 1
- **Tests:** 257 tests run (added test_hook_receiver), all passing

### Pass 2 Fix Verification
- 4 fixes verified correct
- 0 fixes required rework

### Findings & Fixes
| # | Severity | Category | File | Description | Fix |
|---|----------|----------|------|-------------|-----|
| 9 | MEDIUM | Code Quality | `voice_bridge.py:55-61` | Affirmative patterns checked before negative — "don't do it" matched "do it" as affirmative, overriding clear negative intent | Reordered: negation check runs first, then affirmative patterns |

## Consolidated Summary
- **Total lint issues auto-fixed:** 0 (Pass 1: 0, Pass 2: 0, Pass 3: 0)
- **Total review issues found:** 9 (Pass 1: 4, Pass 2: 4, Pass 3: 1)
- **Total fixes applied:** 9
- **Outstanding items:** 0
- **Final lint status:** clean (zero warnings)
- **Final test status:** 257 passed, 0 failures

## Outstanding Items
None — all findings resolved.

## Files Reviewed
```
src/claude_headspace/app.py
src/claude_headspace/config.py
src/claude_headspace/routes/agents.py
src/claude_headspace/routes/debug.py
src/claude_headspace/routes/hooks.py
src/claude_headspace/routes/personas.py
src/claude_headspace/routes/voice_bridge.py
src/claude_headspace/services/advisory_lock.py
src/claude_headspace/services/agent_lifecycle.py
src/claude_headspace/services/agent_reaper.py
src/claude_headspace/services/command_lifecycle.py
src/claude_headspace/services/config_editor.py
src/claude_headspace/services/context_poller.py
src/claude_headspace/services/handoff_executor.py
src/claude_headspace/services/hook_deferred_stop.py
src/claude_headspace/services/hook_receiver.py
src/claude_headspace/services/remote_agent_service.py
src/claude_headspace/services/skill_injector.py
src/claude_headspace/services/summarisation_service.py
src/claude_headspace/services/team_content_detector.py
src/claude_headspace/services/tmux_watchdog.py
src/claude_headspace/services/transcript_reconciler.py
tests/routes/test_agents.py
tests/routes/test_hooks.py
tests/routes/test_personas.py
tests/routes/test_voice_bridge.py
tests/services/test_advisory_lock.py
tests/services/test_context_poller.py
tests/services/test_handoff_executor.py
tests/services/test_hook_receiver.py
tests/services/test_progress_capture_dedup.py
tests/services/test_remote_agent_service.py
tests/test_database.py
```
