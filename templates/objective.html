{% extends "base.html" %}

{% block title %}Objective - Claude Headspace{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include "partials/_header.html" %}

    <main class="page-content container mx-auto px-4 py-6" role="main">
        <!-- Objective Form Section -->
        <section class="mb-8" aria-labelledby="objective-form-heading">
            <div class="bg-elevated rounded-lg border border-border p-6">
                <div class="mb-4 flex items-center justify-between">
                    <h2 id="objective-form-heading" class="text-lg font-bold text-primary">Current Objective</h2>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-secondary font-mono">Priority Scoring</span>
                        <button type="button" id="priority-toggle"
                                class="relative w-12 h-6 rounded-full transition-colors {{ 'bg-cyan' if objective and objective.priority_enabled else 'bg-surface border border-border' if objective else 'bg-surface border border-border opacity-50 cursor-not-allowed' }}"
                                {{ 'disabled' if not objective else '' }}
                                title="{{ 'No objective set' if not objective else ('Disable priority scoring' if objective.priority_enabled else 'Enable priority scoring') }}">
                            <span class="toggle-dot absolute top-1 w-4 h-4 rounded-full bg-primary transition-transform {{ 'left-7' if objective and objective.priority_enabled else 'left-1' }}"></span>
                        </button>
                        <span id="priority-toggle-label" class="text-xs font-mono {{ 'text-green' if objective and objective.priority_enabled else 'text-muted' }}">
                            {{ 'Enabled' if objective and objective.priority_enabled else ('Disabled' if objective else 'Disabled') }}
                        </span>
                    </div>
                </div>

                <form id="objective-form" class="space-y-4">
                    <!-- Objective text field -->
                    <div>
                        <label for="objective-text" class="block text-sm text-secondary mb-2">
                            Objective <span class="text-red">*</span>
                        </label>
                        <input type="text"
                               id="objective-text"
                               name="text"
                               class="w-full px-4 py-3 bg-surface border border-border rounded text-primary placeholder-muted focus:border-cyan focus:outline-none transition-colors"
                               placeholder="What's your objective right now?"
                               value="{{ objective.current_text if objective else '' }}"
                               required
                               aria-describedby="objective-hint">
                    </div>

                    <!-- Constraints field -->
                    <div>
                        <label for="objective-constraints" class="block text-sm text-secondary mb-2">
                            Constraints <span class="text-muted">(optional)</span>
                        </label>
                        <textarea id="objective-constraints"
                                  name="constraints"
                                  rows="3"
                                  class="w-full px-4 py-3 bg-surface border border-border rounded text-primary placeholder-muted focus:border-cyan focus:outline-none transition-colors resize-y"
                                  placeholder="Any constraints or boundaries to keep in mind?">{{ objective.constraints if objective and objective.constraints else '' }}</textarea>
                    </div>

                    <!-- Action buttons -->
                    <div class="flex items-center justify-end gap-3">
                        <span id="save-status" class="text-sm text-muted" role="status" aria-live="polite"></span>
                        <button type="button" id="new-objective-btn"
                                class="px-6 py-2 bg-amber/10 border border-amber/30 rounded text-amber font-medium text-sm hover:bg-amber/20 hover:border-amber transition-colors min-h-[44px]">
                            New objective
                        </button>
                        <button type="submit" id="save-btn"
                                class="px-6 py-2 bg-cyan/20 border border-cyan/30 rounded text-cyan font-medium text-sm hover:bg-cyan/30 hover:border-cyan transition-colors min-h-[44px]">
                            Save
                        </button>
                    </div>
                </form>

                {% if objective and objective.set_at %}
                <div class="mt-4 pt-4 border-t border-border">
                    <p class="text-xs text-muted">
                        Last updated: <time datetime="{{ objective.set_at.isoformat() }}">{{ objective.set_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</time>
                    </p>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Objective History Section -->
        <section aria-labelledby="history-heading">
            <div class="bg-elevated rounded-lg border border-border p-6">
                <h2 id="history-heading" class="text-lg font-bold text-primary mb-4">Objective History</h2>

                {% if history %}
                <div id="history-list" class="space-y-4">
                    {% for item in history %}
                    <article class="p-4 bg-surface rounded border border-border" data-history-id="{{ item.id }}">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <p class="text-primary break-words">{{ item.text }}</p>
                                {% if item.constraints %}
                                <p class="mt-2 text-sm text-secondary break-words">
                                    <span class="text-muted">Constraints:</span> {{ item.constraints }}
                                </p>
                                {% endif %}
                            </div>
                            <button type="button"
                                    class="delete-history-btn flex-shrink-0 text-muted hover:text-red transition-colors text-xs font-mono px-1"
                                    data-history-id="{{ item.id }}"
                                    title="Delete history item">[x]</button>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-4 text-xs text-muted">
                            <span>
                                Started: <time datetime="{{ item.started_at.isoformat() }}">{{ item.started_at.strftime('%Y-%m-%d %H:%M') }}</time>
                            </span>
                            {% if item.ended_at %}
                            <span>
                                Ended: <time datetime="{{ item.ended_at.isoformat() }}">{{ item.ended_at.strftime('%Y-%m-%d %H:%M') }}</time>
                            </span>
                            {% else %}
                            <span class="text-cyan">Current</span>
                            {% endif %}
                        </div>
                    </article>
                    {% endfor %}
                </div>

                {% if has_more %}
                <div class="mt-4 text-center">
                    <button id="load-more-btn"
                            class="px-6 py-2 bg-surface border border-border rounded text-secondary hover:text-primary hover:border-cyan transition-colors min-h-[44px]"
                            data-page="2"
                            data-total="{{ total_history }}">
                        Load more
                    </button>
                </div>
                {% endif %}
                {% else %}
                <div id="empty-history" class="text-center py-8">
                    <p class="text-secondary">No objective history yet.</p>
                    <p class="text-muted text-sm mt-1">Set your first objective above to get started.</p>
                </div>
                {% endif %}
            </div>
        </section>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/objective.js') }}"></script>
{% endblock %}
