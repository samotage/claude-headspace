{% extends "base.html" %}

{% block title %}Dashboard - Claude Headspace{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include "partials/_header.html" %}

    <main class="container mx-auto px-4 py-6" role="main">
        <!-- Recommended Next Panel -->
        {% include "partials/_recommended_next.html" %}

        <!-- Sort Controls -->
        {% include "partials/_sort_controls.html" %}

        <!-- Content based on sort mode -->
        {% if sort_mode == 'priority' %}
            <!-- By Priority View: Flat list of agents -->
            {% if priority_sorted_agents %}
                <div class="space-y-4" id="priority-view">
                    {% for agent in priority_sorted_agents %}
                        <article class="bg-elevated rounded-lg border border-border overflow-hidden"
                                 data-agent-id="{{ agent.id }}"
                                 data-state="{{ agent.state.name }}"
                                 aria-labelledby="agent-{{ agent.id }}-heading">
                            <!-- Card header: Status, Session ID, Project, Uptime -->
                            <div class="flex items-center justify-between p-3 border-b border-border">
                                <div class="flex items-center gap-2">
                                    <!-- Status badge -->
                                    {% if agent.is_active %}
                                        <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-green/20 text-green"
                                              role="status">
                                            ACTIVE
                                        </span>
                                    {% else %}
                                        <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-muted/20 text-muted"
                                              role="status">
                                            IDLE
                                        </span>
                                    {% endif %}

                                    <!-- Session ID -->
                                    <h3 id="agent-{{ agent.id }}-heading" class="text-primary font-mono text-sm">
                                        #{{ agent.session_uuid }}
                                    </h3>

                                    <!-- Project name (in priority view) -->
                                    <span class="text-muted text-sm">
                                        {{ agent.project_name }}
                                    </span>
                                </div>

                                <!-- Uptime -->
                                <span class="uptime text-muted text-xs">
                                    {{ agent.uptime }}
                                </span>
                            </div>

                            <!-- State bar -->
                            <div class="px-3 py-2"
                                 role="status"
                                 aria-label="Agent state: {{ agent.state_info.label }}">
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 h-2 rounded-full bg-deep overflow-hidden">
                                        <div class="state-bar h-full {{ agent.state_info.bg_class }} transition-all duration-300"
                                             style="width: 100%;"
                                             aria-hidden="true"></div>
                                    </div>
                                    <span class="state-label text-xs text-secondary whitespace-nowrap">
                                        {{ agent.state_info.label }}
                                    </span>
                                </div>
                            </div>

                            <!-- Task summary -->
                            <div class="px-3 py-2 border-t border-border">
                                <p class="task-summary text-secondary text-sm line-clamp-2">
                                    {{ agent.task_summary }}
                                </p>
                            </div>

                            <!-- Footer: Priority and Headspace button -->
                            <div class="flex items-center justify-between px-3 py-2 border-t border-border bg-deep">
                                <!-- Priority score -->
                                <span class="px-2 py-1 text-xs font-mono rounded bg-surface text-muted"
                                      title="Priority score">
                                    [{{ agent.priority }}]
                                </span>

                                <!-- Headspace button -->
                                <button class="headspace-btn px-3 py-1 text-xs font-medium rounded bg-cyan/20 text-cyan hover:bg-cyan/30 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                                        onclick="window.FocusAPI && window.FocusAPI.focusAgent({{ agent.id }})"
                                        title="Focus on this agent's iTerm window">
                                    Headspace
                                </button>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No agents found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% else %}
            <!-- By Project View: Default layout -->
            {% if projects %}
                <div class="space-y-6" id="project-view">
                    {% for project in projects %}
                        {% include "partials/_project_group.html" %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No projects found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% endif %}
    </main>
</div>

<!-- Toast container -->
{% include "partials/_toast.html" %}

<!-- Waypoint Editor Modal -->
{% include "partials/_waypoint_editor.html" %}
{% endblock %}

{% block scripts %}
<!-- SSE client (from Sprint 7) -->
<script src="{{ url_for('static', filename='js/sse-client.js') }}"></script>
<!-- Dashboard SSE integration -->
<script src="{{ url_for('static', filename='js/dashboard-sse.js') }}"></script>
<!-- Focus API client -->
<script src="{{ url_for('static', filename='js/focus-api.js') }}"></script>
{% endblock %}
