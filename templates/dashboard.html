{% extends "base.html" %}

{% block title %}Dashboard - Claude Headspace{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include "partials/_header.html" %}

    <main class="page-content px-4 py-6 {{ 'container mx-auto' if sort_mode == 'priority' else '' }}" role="main">
        <!-- Objective Banner -->
        {% include "partials/_objective_banner.html" %}

        <!-- Recommended Next Panel (only when prioritisation is enabled and there's a recommendation) -->
        {% if objective and objective.priority_enabled and recommended_next %}
        {% include "partials/_recommended_next.html" %}
        {% endif %}

        <!-- Sort Controls + New Agent -->
        <div class="flex items-center justify-between gap-4 mb-4">
            <div class="flex-1">
                {% include "partials/_sort_controls.html" %}
            </div>
            <!-- New Agent Control -->
            <div class="flex items-center gap-2" id="new-agent-control">
                <div class="new-agent-wrapper">
                    <button id="new-agent-btn" class="px-3 py-1 text-sm font-medium rounded border transition-colors bg-green/20 text-green border-green/30 hover:bg-green/30 min-h-[36px]" title="Create new agent" aria-expanded="false">
                        + Agent
                    </button>
                    <div id="new-agent-menu" class="new-agent-menu">
                        <div class="new-agent-menu-header">spawn agent</div>
                        <div class="new-agent-menu-body">
                            {% for project in all_projects %}
                            <button class="new-agent-item" data-project-id="{{ project.id }}">{{ project.name }}</button>
                            {% endfor %}
                            {% if not all_projects %}
                            <span class="new-agent-item-empty">No projects found</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <a href="/voice" class="px-3 py-1 text-sm font-medium rounded border transition-colors bg-blue/20 text-blue border-blue/30 hover:bg-blue/30 min-h-[36px] inline-flex items-center no-underline" title="Open chat view">
                    Chat
                </a>
            </div>
        </div>

        <!-- Content based on sort mode -->
        {% if sort_mode == 'kanban' %}
            <!-- Kanban View: Tasks by lifecycle state -->
            {% if kanban_data %}
                {% include "partials/_kanban_view.html" %}
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No agents found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% elif sort_mode == 'priority' %}
            <!-- By Priority View: Flat list of agents -->
            {% if priority_sorted_agents %}
                <div class="space-y-4" id="priority-view">
                    {% for agent in priority_sorted_agents %}
                        <article class="bg-elevated rounded-lg border border-border overflow-hidden focus-target transition-shadow duration-300"
                                 data-agent-id="{{ agent.id }}"
                                 data-state="{{ agent.state.name }}"
                                 aria-labelledby="agent-{{ agent.id }}-heading">
                          <div class="card-editor">
                            <!-- 01: Header row -->
                            <div class="card-line">
                              <span class="line-num">01</span>
                              <div class="line-content flex items-baseline justify-between">
                                <div class="flex flex-wrap items-baseline gap-2">
                                  <h3 id="agent-{{ agent.id }}-heading" class="flex items-baseline gap-0.5">
                                    <span class="agent-hero">{{ agent.hero_chars }}</span><span class="agent-hero-trail">{{ agent.hero_trail }}</span>
                                  </h3>
                                  <a href="/projects/{{ agent.project_slug }}" class="text-cyan text-sm hidden sm:inline hover:text-primary text-glow-cyan transition-colors">{{ agent.project_name }}</a>
                                </div>
                                <div class="flex items-baseline gap-2">
                                  <span class="uptime text-muted text-xs hidden sm:inline">{{ agent.uptime }}</span>
                                  {% if agent.is_active %}
                                    <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-green/20 text-green"
                                          role="status">ACTIVE</span>
                                  {% else %}
                                    <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-muted/20 text-muted"
                                          role="status">IDLE</span>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                            <!-- 02: State strip (clickable - focuses iTerm) -->
                            <div class="card-line">
                              <span class="line-num">02</span>
                              <div class="line-content">
                                <div class="state-bar state-strip clickable"
                                     role="button" tabindex="0"
                                     aria-label="Focus iTerm: {{ agent.state_info.label }}"
                                     title="Click to focus this agent's iTerm window"
                                     onclick="window.FocusAPI && window.FocusAPI.focusAgent({{ agent.id }})"
                                     onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window.FocusAPI && window.FocusAPI.focusAgent({{ agent.id }});}">
                                  <span class="state-label">{{ agent.state_info.label }}</span>
                                </div>
                              </div>
                            </div>
                            <!-- 03: Task instruction (primary line) -->
                            <div class="card-line">
                              <span class="line-num">03</span>
                              <div class="line-content">
                                {% if agent.task_instruction %}
                                  <p class="task-instruction text-primary text-sm font-medium">{{ agent.task_instruction }}</p>
                                {% else %}
                                  <p class="task-instruction text-muted text-sm italic">No active task</p>
                                {% endif %}
                              </div>
                            </div>
                            <!-- 04: Turn summary â€” only if different from instruction -->
                            {% if agent.task_summary and agent.task_summary != agent.task_instruction %}
                            <div class="card-line">
                              <span class="line-num">04</span>
                              <div class="line-content">
                                {% if agent.state_name == 'COMPLETE' or agent.state_name == 'IDLE' %}
                                  {% if agent.task_completion_summary %}
                                    <p class="task-summary text-green text-sm italic">{{ agent.task_completion_summary }}</p>
                                  {% else %}
                                    <p class="task-summary text-secondary text-sm italic">{{ agent.task_summary }}</p>
                                  {% endif %}
                                {% else %}
                                  <p class="task-summary text-secondary text-sm italic">{{ agent.task_summary }}</p>
                                {% endif %}
                              </div>
                            </div>
                            {% elif not agent.task_summary and agent.task_instruction %}
                            <div class="card-line">
                              <span class="line-num">04</span>
                              <div class="line-content">
                                <p class="task-summary text-muted text-sm italic">Awaiting summary...</p>
                              </div>
                            </div>
                            {% endif %}
                          </div>
                          <!-- Priority footer -->
                          <div class="flex items-center gap-3 px-3 py-2 border-t border-border">
                            <span class="px-2 py-0.5 text-xs font-mono rounded border border-border text-secondary">{{ agent.priority }}</span>
                            <span class="text-muted text-xs italic">// {{ agent.task_summary[:50] if agent.task_summary else 'Priority score' }}</span>
                          </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No agents found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% else %}
            <!-- By Project View: Kanban columns -->
            {% if projects %}
                <div class="flex flex-col gap-4 pb-4 md:flex-row md:overflow-x-auto lg:flex-wrap lg:overflow-visible" id="project-view"
                     style="min-height: calc(100vh - 280px);">
                    {% for project in projects %}
                        {% include "partials/_project_column.html" %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No projects found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% endif %}
    </main>
</div>

<!-- Toast container -->
{% include "partials/_toast.html" %}

<!-- Waypoint Editor Modal -->
{% include "partials/_waypoint_editor.html" %}

<!-- Brain Reboot Modal -->
{% include "partials/_brain_reboot_modal.html" %}

<!-- Agent Info Modal -->
{% include "partials/_agent_info_modal.html" %}
{% endblock %}

{% block scripts %}
<!-- Dashboard SSE integration (uses shared SSE client from base.html) -->
<script src="{{ url_for('static', filename='js/dashboard-sse.js') }}?v={{ cache_bust }}"></script>
<!-- Focus API client -->
<script src="{{ url_for('static', filename='js/focus-api.js') }}?v={{ cache_bust }}"></script>
<!-- Respond API client (Input Bridge) -->
<script src="{{ url_for('static', filename='js/respond-api.js') }}?v={{ cache_bust }}"></script>
<script src="{{ url_for('static', filename='js/respond-init.js') }}?v={{ cache_bust }}"></script>
<!-- Card text tooltip (truncation expand) -->
<script src="{{ url_for('static', filename='js/card-tooltip.js') }}?v={{ cache_bust }}"></script>
<!-- Brain Reboot -->
<script src="{{ url_for('static', filename='js/brain-reboot.js') }}?v={{ cache_bust }}"></script>
<!-- Full-text drill-down modal -->
<script src="{{ url_for('static', filename='js/full-text-modal.js') }}?v={{ cache_bust }}"></script>
<!-- Agent Info slider -->
<script src="{{ url_for('static', filename='js/agent-info.js') }}?v={{ cache_bust }}"></script>
<!-- Agent lifecycle (create, kill, context) -->
<script src="{{ url_for('static', filename='js/agent-lifecycle.js') }}?v={{ cache_bust }}"></script>
{% endblock %}
