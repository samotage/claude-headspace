{% extends "base.html" %}

{% block title %}Dashboard - Claude Headspace{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include "partials/_header.html" %}

    <main class="page-content px-4 py-6 {{ 'container mx-auto' if sort_mode == 'priority' else '' }}" role="main">
        <!-- Activity Metrics Bar -->
        {% include "partials/_activity_bar.html" %}

        <!-- Objective Banner -->
        {% include "partials/_objective_banner.html" %}

        <!-- Recommended Next Panel -->
        {% include "partials/_recommended_next.html" %}

        <!-- Sort Controls -->
        {% include "partials/_sort_controls.html" %}

        <!-- Content based on sort mode -->
        {% if sort_mode == 'kanban' %}
            <!-- Kanban View: Tasks by lifecycle state -->
            {% if kanban_data %}
                {% include "partials/_kanban_view.html" %}
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No agents found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% elif sort_mode == 'priority' %}
            <!-- By Priority View: Flat list of agents -->
            {% if priority_sorted_agents %}
                <div class="space-y-4" id="priority-view">
                    {% for agent in priority_sorted_agents %}
                        <article class="bg-elevated rounded-lg border border-border overflow-hidden focus-target transition-shadow duration-300"
                                 data-agent-id="{{ agent.id }}"
                                 data-state="{{ agent.state.name }}"
                                 aria-labelledby="agent-{{ agent.id }}-heading">
                          <div class="card-editor">
                            <!-- 01: Header row -->
                            <div class="card-line">
                              <span class="line-num">01</span>
                              <div class="line-content flex items-center justify-between">
                                <div class="flex flex-wrap items-center gap-2">
                                  <h3 id="agent-{{ agent.id }}-heading" class="flex items-baseline gap-0.5">
                                    <span class="agent-hero">{{ agent.hero_chars }}</span><span class="agent-hero-trail">{{ agent.hero_trail }}</span>
                                  </h3>
                                  <span class="text-muted text-sm hidden sm:inline">{{ agent.project_name }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                  <span class="uptime text-muted text-xs hidden sm:inline">{{ agent.uptime }}</span>
                                  {% if agent.is_active %}
                                    <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-green/20 text-green"
                                          role="status">ACTIVE</span>
                                  {% else %}
                                    <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-muted/20 text-muted"
                                          role="status">IDLE</span>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                            <!-- 02: State strip (clickable - focuses iTerm) -->
                            <div class="card-line">
                              <span class="line-num">02</span>
                              <div class="line-content">
                                <div class="state-bar state-strip clickable"
                                     role="button" tabindex="0"
                                     aria-label="Focus iTerm: {{ agent.state_info.label }}"
                                     title="Click to focus this agent's iTerm window"
                                     onclick="window.FocusAPI && window.FocusAPI.focusAgent({{ agent.id }})"
                                     onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window.FocusAPI && window.FocusAPI.focusAgent({{ agent.id }});}">
                                  <span class="state-label">{{ agent.state_info.label }}</span>
                                </div>
                              </div>
                            </div>
                            <!-- 03: Task instruction (primary line) -->
                            <div class="card-line">
                              <span class="line-num">03</span>
                              <div class="line-content">
                                {% if agent.task_instruction %}
                                  <p class="task-instruction text-primary text-sm font-medium truncate">{{ agent.task_instruction }}</p>
                                {% else %}
                                  <p class="task-instruction text-muted text-sm italic">No active task</p>
                                {% endif %}
                              </div>
                            </div>
                            <!-- 04: Turn summary (active task) or completion summary (complete task) -->
                            <div class="card-line">
                              <span class="line-num">04</span>
                              <div class="line-content">
                                {% if agent.state_name == 'COMPLETE' or agent.state_name == 'IDLE' %}
                                  {% if agent.task_completion_summary %}
                                    <p class="task-summary text-green text-sm italic truncate">{{ agent.task_completion_summary }}</p>
                                  {% else %}
                                    <p class="task-summary text-secondary text-sm italic truncate">{{ agent.task_summary }}</p>
                                  {% endif %}
                                {% else %}
                                  <p class="task-summary text-secondary text-sm italic truncate">{{ agent.task_summary }}</p>
                                {% endif %}
                              </div>
                            </div>
                          </div>
                          <!-- Priority footer -->
                          <div class="flex items-center gap-3 px-3 py-2 border-t border-border">
                            <span class="px-2 py-0.5 text-xs font-mono rounded border border-border text-secondary">{{ agent.priority }}</span>
                            <span class="text-muted text-xs italic">// {{ agent.task_summary[:50] if agent.task_summary else 'Priority score' }}</span>
                          </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No agents found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% else %}
            <!-- By Project View: Kanban columns -->
            {% if projects %}
                <div class="flex flex-col gap-4 pb-4 md:flex-row md:overflow-x-auto" id="project-view"
                     style="min-height: calc(100vh - 280px);">
                    {% for project in projects %}
                        {% include "partials/_project_column.html" %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <p class="text-secondary text-lg">No projects found.</p>
                    <p class="text-muted mt-2">Start a Claude Code session to see agents here.</p>
                </div>
            {% endif %}
        {% endif %}
    </main>
</div>

<!-- Toast container -->
{% include "partials/_toast.html" %}

<!-- Waypoint Editor Modal -->
{% include "partials/_waypoint_editor.html" %}

<!-- Brain Reboot Modal -->
{% include "partials/_brain_reboot_modal.html" %}
{% endblock %}

{% block scripts %}
<!-- Dashboard SSE integration (uses shared SSE client from base.html) -->
<script src="{{ url_for('static', filename='js/dashboard-sse.js') }}?v={{ cache_bust }}"></script>
<!-- Focus API client -->
<script src="{{ url_for('static', filename='js/focus-api.js') }}?v={{ cache_bust }}"></script>
<!-- Respond API client (Input Bridge) -->
<script src="{{ url_for('static', filename='js/respond-api.js') }}?v={{ cache_bust }}"></script>
<script src="{{ url_for('static', filename='js/respond-init.js') }}?v={{ cache_bust }}"></script>
<!-- Card text tooltip (truncation expand) -->
<script src="{{ url_for('static', filename='js/card-tooltip.js') }}?v={{ cache_bust }}"></script>
<!-- Brain Reboot -->
<script src="{{ url_for('static', filename='js/brain-reboot.js') }}?v={{ cache_bust }}"></script>
{% endblock %}
