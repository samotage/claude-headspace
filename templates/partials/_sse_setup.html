{# SSE Setup Partial - Include in pages that need real-time updates #}

<script src="{{ url_for('static', filename='js/sse-client.js') }}"></script>
<script>
  (function() {
    // Initialize SSE client with optional filters from data attributes
    const setupEl = document.getElementById('sse-setup');
    const config = {};

    if (setupEl) {
      if (setupEl.dataset.types) {
        config.types = setupEl.dataset.types.split(',');
      }
      if (setupEl.dataset.projectId) {
        config.projectId = parseInt(setupEl.dataset.projectId, 10);
      }
      if (setupEl.dataset.agentId) {
        config.agentId = parseInt(setupEl.dataset.agentId, 10);
      }
    }

    // Create global SSE client instance
    window.sseClient = new SSEClient(config);

    // Log state changes
    window.sseClient.onStateChange(function(newState, oldState) {
      console.log('SSE state changed:', oldState, '->', newState);

      // Dispatch custom event for UI updates
      document.dispatchEvent(new CustomEvent('sse-state-change', {
        detail: { state: newState, previousState: oldState }
      }));
    });

    // Handle state_transition events - update agent cards
    window.sseClient.on('state_transition', function(data) {
      console.log('State transition:', data);

      // Dispatch custom event for HTMX/UI to handle
      document.dispatchEvent(new CustomEvent('agent-state-change', {
        detail: data
      }));

      // If HTMX is available, trigger refresh of agent card
      if (window.htmx && data.agent_id) {
        const agentCard = document.querySelector('[data-agent-id="' + data.agent_id + '"]');
        if (agentCard) {
          htmx.trigger(agentCard, 'sse-refresh');
        }
      }
    });

    // Handle agent_created events
    window.sseClient.on('agent_created', function(data) {
      console.log('Agent created:', data);

      document.dispatchEvent(new CustomEvent('agent-created', {
        detail: data
      }));

      // Trigger dashboard refresh if HTMX available
      if (window.htmx) {
        const dashboard = document.getElementById('agent-dashboard');
        if (dashboard) {
          htmx.trigger(dashboard, 'sse-refresh');
        }
      }
    });

    // Handle agent_updated events
    window.sseClient.on('agent_updated', function(data) {
      console.log('Agent updated:', data);

      document.dispatchEvent(new CustomEvent('agent-updated', {
        detail: data
      }));
    });

    // Handle error events
    window.sseClient.on('error', function(data) {
      console.error('SSE error event:', data);

      document.dispatchEvent(new CustomEvent('sse-error', {
        detail: data
      }));
    });

    // Auto-connect when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        window.sseClient.connect();
      });
    } else {
      window.sseClient.connect();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (window.sseClient) {
        window.sseClient.disconnect();
      }
    });
  })();
</script>
