<article class="bg-elevated rounded-lg border border-border overflow-visible focus-target transition-shadow duration-300"
         data-agent-id="{{ agent.id }}"
         data-state="{{ agent.state_name }}"
         aria-labelledby="agent-{{ agent.id }}-heading">
  <div class="card-editor">
    <!-- 01: Header row -->
    <div class="card-line">
      <span class="line-num">01</span>
      <div class="line-content flex items-baseline justify-between">
        <div class="flex flex-wrap items-baseline gap-2">
          <h3 id="agent-{{ agent.id }}-heading" class="flex items-baseline gap-0.5">
            <span class="agent-hero">{{ agent.hero_chars }}</span><span class="agent-hero-trail">{{ agent.hero_trail }}</span>
          </h3>
          <span class="last-seen text-muted text-xs">{{ agent.last_seen }}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="uptime text-muted text-xs hidden sm:inline whitespace-nowrap">{{ agent.uptime }}</span>
          {% if agent.is_bridge_connected %}
            <span class="bridge-indicator" title="Bridge connected — tmux pane active" aria-label="Bridge connected">
              <span class="bridge-icon">▸◂</span>
            </span>
          {% endif %}
          {% if agent.is_active %}
            <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-green/20 text-green"
                  role="status" {% if agent.is_bridge_connected %}style="display:none"{% endif %}>ACTIVE</span>
          {% else %}
            <span class="status-badge px-2 py-0.5 text-xs font-medium rounded bg-muted/20 text-muted"
                  role="status" {% if agent.is_bridge_connected %}style="display:none"{% endif %}>IDLE</span>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- 02: State strip (clickable - focuses iTerm) -->
    <div class="card-line">
      <span class="line-num">02</span>
      <div class="line-content">
        <div class="state-bar state-strip clickable"
             role="button" tabindex="0"
             aria-label="Focus iTerm: {{ agent.state_info.label }}"
             title="Click to focus this agent's iTerm window"
             onclick="window.FocusAPI && window.FocusAPI.focusAgent({{ agent.id }})"
             onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window.FocusAPI && window.FocusAPI.focusAgent({{ agent.id }});}">
          <span class="state-label">{{ agent.state_info.label }}{% if agent.state_name == 'AWAITING_INPUT' and agent.question_options and agent.question_options.safety is defined %} · <span class="safety-hint safety-hint-{{ agent.question_options.safety }}">{% if agent.question_options.safety == 'safe_read' %}read{% elif agent.question_options.safety == 'destructive' %}destructive{% elif agent.question_options.safety == 'safe_write' %}write{% else %}write{% endif %}</span>{% endif %}</span>
        </div>
      </div>
    </div>
    <!-- 03: Task instruction (primary line) -->
    <div class="card-line">
      <span class="line-num">03</span>
      <div class="line-content flex items-baseline justify-between gap-2">
        {% if agent.task_instruction %}
          <p class="task-instruction text-primary text-sm font-medium flex-1 min-w-0">{{ agent.task_instruction }}</p>
        {% else %}
          <p class="task-instruction text-muted text-sm italic">No active task</p>
        {% endif %}
        {% if agent.has_plan and agent.current_task_id %}
          <button type="button" class="plan-indicator plan-indicator-btn" title="View plan" aria-label="View agent plan"
                  onclick="window.FullTextModal && window.FullTextModal.show({{ agent.current_task_id }}, 'plan')">plan</button>
        {% endif %}
      </div>
    </div>
    <!-- 04: Turn summary (active task) or completion summary (complete task) -->
    <!-- Hidden when it would just repeat line 03 -->
    {% set line04_text = '' %}
    {% if agent.state_name == 'COMPLETE' or agent.state_name == 'IDLE' %}
      {% if agent.task_completion_summary %}
        {% set line04_text = agent.task_completion_summary %}
      {% else %}
        {% set line04_text = agent.task_summary or '' %}
      {% endif %}
    {% else %}
      {% set line04_text = agent.task_summary or '' %}
    {% endif %}
    {% set line03_text = agent.task_instruction or 'No active task' %}
    {% if line04_text and line04_text != line03_text %}
    <div class="card-line card-line-04">
      <span class="line-num">04</span>
      <div class="line-content flex items-baseline justify-between gap-2">
        {% if (agent.state_name == 'COMPLETE' or agent.state_name == 'IDLE') and agent.task_completion_summary %}
          <p class="task-summary text-green text-sm italic flex-1 min-w-0">{{ line04_text }}</p>
        {% else %}
          <p class="task-summary text-secondary text-sm italic flex-1 min-w-0">{{ line04_text }}</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  <!-- Context usage display (populated on-demand via JS) -->
  <div class="agent-ctx-display px-3 py-1 text-xs hidden" data-agent-id="{{ agent.id }}"></div>
  <!-- 05: Respond widget (AWAITING_INPUT only, hidden until commander availability confirmed) -->
  {% if agent.state_name == 'AWAITING_INPUT' %}
  {% set safety = agent.question_options.safety if agent.question_options and agent.question_options.safety is defined else '' %}
  <div class="respond-widget px-3 py-2 border-t border-amber/20 bg-amber/5"
       data-agent-id="{{ agent.id }}"
       data-safety="{{ safety }}"
       data-question-text="{{ agent.task_summary|e }}"
       {% if agent.question_options %}data-question-options='{{ agent.question_options|tojson }}'{% endif %}
       style="display:none;">
    <div class="respond-options flex flex-wrap gap-1.5 mb-2"></div>
    <form class="respond-form flex items-start gap-2"
          onsubmit="window.RespondAPI && window.RespondAPI.handleSubmit(event, {{ agent.id }}); return false;">
      <textarea class="respond-text-input form-well flex-1 px-2 py-1 text-sm"
                placeholder="Type a response..."
                autocomplete="off"
                rows="1"
                style="resize:none;overflow:hidden;min-height:1.75rem;max-height:10rem;"></textarea>
      <button type="submit" class="respond-send-btn px-3 py-1 text-xs font-medium rounded border transition-colors bg-amber/20 text-amber border-amber/30 hover:bg-amber/30">
        Send
      </button>
    </form>
  </div>
  {% endif %}
  <!-- Priority + task stats footer -->
  <div class="relative z-[1] flex items-center justify-between gap-3 py-2 border-t border-border" style="padding-left:10px;padding-right:12px">
    <div class="flex items-center gap-3">
      <span class="priority-score px-1.5 py-0.5 text-[11px] font-mono font-medium rounded-sm" data-priority="{{ agent.priority }}">{{ agent.priority }}</span>
      {% if agent.turn_count and agent.turn_count > 0 %}
        <span class="task-stats text-muted text-xs">{{ agent.turn_count }} turn{{ 's' if agent.turn_count != 1 else '' }}{% if agent.elapsed %} · {{ agent.elapsed }}{% endif %}</span>
      {% endif %}
      {% if agent.context_percent_used is not none %}
        {% set ctx_class = 'text-muted' %}
        {% if context_thresholds is defined and agent.context_percent_used >= context_thresholds.high %}
          {% set ctx_class = 'text-red' %}
        {% elif context_thresholds is defined and agent.context_percent_used >= context_thresholds.warning %}
          {% set ctx_class = 'text-amber' %}
        {% endif %}
        <span class="context-usage {{ ctx_class }} text-xs font-mono whitespace-nowrap"
              data-agent-id="{{ agent.id }}">{{ agent.context_percent_used }}% · {{ agent.context_remaining_tokens }} rem</span>
      {% endif %}
    </div>
    <div class="card-kebab-wrapper">
      <button class="card-kebab-btn" data-agent-id="{{ agent.id }}" title="Actions" aria-label="Agent actions" aria-expanded="false">&#8942;</button>
      <div class="card-kebab-menu" data-agent-id="{{ agent.id }}">
        <button class="card-kebab-item card-chat-action" data-agent-id="{{ agent.id }}">
          <svg class="kebab-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 13h1l7-7-1-1-7 7zm9.5-9.5 1 1m-2-2 1.44-1.44a.7.7 0 0 1 1 0l1 1a.7.7 0 0 1 0 1L12.5 4.5"/></svg>
          <span>Chat</span>
        </button>
        <button class="card-kebab-item card-ctx-action" data-agent-id="{{ agent.id }}">
          <svg class="kebab-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="5.5"/><path d="M8 5v3.5L10.5 10"/></svg>
          <span>Fetch context</span>
        </button>
        <button class="card-kebab-item card-info-action" data-agent-id="{{ agent.id }}">
          <svg class="kebab-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="5.5"/><path d="M8 5.5v4"/><circle cx="8" cy="11.5" r="0.5" fill="currentColor" stroke="none"/></svg>
          <span>Agent info</span>
        </button>
        <div class="kebab-divider"></div>
        <button class="card-kebab-item card-kill-action" data-agent-id="{{ agent.id }}" data-hero-chars="{{ agent.hero_chars }}" data-hero-trail="{{ agent.hero_trail }}">
          <svg class="kebab-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l10 10M13 3L3 13"/></svg>
          <span>Dismiss agent</span>
        </button>
      </div>
    </div>
  </div>
</article>
