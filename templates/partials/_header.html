<!-- Tab Navigation -->
<nav class="tab-nav" role="banner">
    <a class="nav-brand" href="{{ url_for('dashboard.dashboard') }}" title="CLAUDE headspace">
        <pre class="nav-ascii" aria-label="CLAUDE"> ██████╗██╗      █████╗ ██╗   ██╗██████╗ ███████╗
██╔════╝██║     ██╔══██╗██║   ██║██╔══██╗██╔════╝
██║     ██║     ███████║██║   ██║██║  ██║█████╗
██║     ██║     ██╔══██║██║   ██║██║  ██║██╔══╝
╚██████╗███████╗██║  ██║╚██████╔╝██████╔╝███████╗
 ╚═════╝╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚══════╝</pre><span class="nav-brand-cursor">&gt;_</span><span class="nav-brand-suffix">headspace</span>
    </a>
    <div class="tab-btn-group" role="navigation" aria-label="Main navigation">
        <a href="{{ url_for('dashboard.dashboard') }}" data-nav-key="dashboard"
           class="tab-link {% if request.endpoint == 'dashboard.dashboard' %}active{% endif %}"
           {% if request.endpoint == 'dashboard.dashboard' %}aria-current="page"{% endif %}>dashboard</a>
        <a href="{{ url_for('projects.projects_page') }}" data-nav-key="projects"
           class="tab-link {% if request.endpoint and request.endpoint.startswith('projects.') %}active{% endif %}"
           {% if request.endpoint and request.endpoint.startswith('projects.') %}aria-current="page"{% endif %}>projects</a>
        <a href="{{ url_for('activity.activity_page') }}" data-nav-key="activity"
           class="tab-link {% if request.endpoint == 'activity.activity_page' %}active{% endif %}"
           {% if request.endpoint == 'activity.activity_page' %}aria-current="page"{% endif %}>activity</a>
        <a href="{{ url_for('objective.objective_page') }}" data-nav-key="objective"
           class="tab-link {% if request.endpoint == 'objective.objective_page' %}active{% endif %}"
           {% if request.endpoint == 'objective.objective_page' %}aria-current="page"{% endif %}>objective</a>
        <a href="{{ url_for('logging.logging_page') }}" data-nav-key="logging"
           class="tab-link {% if request.endpoint and request.endpoint.startswith('logging.') %}active{% endif %}"
           {% if request.endpoint and request.endpoint.startswith('logging.') %}aria-current="page"{% endif %}>logging</a>
        <a href="{{ url_for('config.config_page') }}" data-nav-key="config"
           class="tab-link {% if request.endpoint == 'config.config_page' %}active{% endif %}"
           {% if request.endpoint == 'config.config_page' %}aria-current="page"{% endif %}>config</a>
        <a href="{{ url_for('help.help_page') }}" data-nav-key="help"
           class="tab-link {% if request.endpoint and request.endpoint.startswith('help.') %}active{% endif %}"
           {% if request.endpoint and request.endpoint.startswith('help.') %}aria-current="page"{% endif %}>help</a>
        <a href="{{ url_for('personas.personas_page') }}" data-nav-key="personas"
           class="tab-link {% if request.endpoint and request.endpoint.startswith('personas.') %}active{% endif %}"
           {% if request.endpoint and request.endpoint.startswith('personas.') %}aria-current="page"{% endif %}>personas</a>
    </div>
    <!-- Hamburger Menu Button (mobile only) -->
    <button class="hamburger-btn" onclick="toggleMobileMenu()" aria-label="Menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </button>
</nav>

<!-- Mobile Menu Drawer -->
<div id="mobile-menu-overlay" class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
<div id="mobile-menu" class="mobile-menu">
    <div class="mobile-menu-header">
        <span class="mobile-menu-title">&gt;_ menu</span>
        <button class="mobile-menu-close" onclick="closeMobileMenu()">&times;</button>
    </div>
    <div class="mobile-menu-items">
        <a href="{{ url_for('dashboard.dashboard') }}" data-nav-key="dashboard"
           class="mobile-menu-item {% if request.endpoint == 'dashboard.dashboard' %}active{% endif %}">
            <span class="mobile-menu-icon">&#9632;</span>
            <span>dashboard</span>
        </a>
        <a href="{{ url_for('projects.projects_page') }}" data-nav-key="projects"
           class="mobile-menu-item {% if request.endpoint and request.endpoint.startswith('projects.') %}active{% endif %}">
            <span class="mobile-menu-icon">&#9783;</span>
            <span>projects</span>
        </a>
        <a href="{{ url_for('activity.activity_page') }}" data-nav-key="activity"
           class="mobile-menu-item {% if request.endpoint == 'activity.activity_page' %}active{% endif %}">
            <span class="mobile-menu-icon">&#9829;</span>
            <span>activity</span>
        </a>
        <a href="{{ url_for('objective.objective_page') }}" data-nav-key="objective"
           class="mobile-menu-item {% if request.endpoint == 'objective.objective_page' %}active{% endif %}">
            <span class="mobile-menu-icon">&#9673;</span>
            <span>objective</span>
        </a>
        <a href="{{ url_for('logging.logging_page') }}" data-nav-key="logging"
           class="mobile-menu-item {% if request.endpoint and request.endpoint.startswith('logging.') %}active{% endif %}">
            <span class="mobile-menu-icon">&#9998;</span>
            <span>logging</span>
        </a>
        <a href="{{ url_for('config.config_page') }}" data-nav-key="config"
           class="mobile-menu-item {% if request.endpoint == 'config.config_page' %}active{% endif %}">
            <span class="mobile-menu-icon">&#9881;</span>
            <span>config</span>
        </a>
        <a href="{{ url_for('help.help_page') }}" data-nav-key="help"
           class="mobile-menu-item {% if request.endpoint and request.endpoint.startswith('help.') %}active{% endif %}">
            <span class="mobile-menu-icon">?</span>
            <span>help</span>
        </a>
        <a href="{{ url_for('personas.personas_page') }}" data-nav-key="personas"
           class="mobile-menu-item {% if request.endpoint and request.endpoint.startswith('personas.') %}active{% endif %}">
            <span class="mobile-menu-icon">&#9786;</span>
            <span>personas</span>
        </a>
    </div>
</div>

<!-- Stats Bar -->
{% set status_counts = status_counts|default({"input_needed": 0, "working": 0, "idle": 0}) %}
<div class="stats-bar" id="stats-bar" role="status" aria-live="polite">
    <div id="status-input-needed" class="stat-item">
        <span class="stat-dot amber" aria-hidden="true"></span>
        <span class="stat-label amber">INPUT NEEDED</span>
        <span class="status-count stat-value">[{{ status_counts.input_needed }}]</span>
    </div>
    <div id="status-working" class="stat-item">
        <span class="stat-dot blue" aria-hidden="true"></span>
        <span class="stat-label blue">WORKING</span>
        <span class="status-count stat-value">[{{ status_counts.working }}]</span>
    </div>
    <div id="status-idle" class="stat-item">
        <span class="stat-dot green" aria-hidden="true"></span>
        <span class="stat-label green">IDLE</span>
        <span class="status-count stat-value">[{{ status_counts.idle }}]</span>
    </div>
    <div class="connection-indicator" id="connection-indicator" role="status" aria-live="polite">
        <span class="connection-dot" aria-hidden="true"></span>
        <span class="connection-text">Connecting...</span>
    </div>
</div>

<!-- Headspace Alert Banner (hidden by default) -->
<div id="headspace-alert-banner" class="headspace-alert-banner hidden" role="alert" aria-live="assertive">
    <span id="headspace-alert-message" class="headspace-alert-text"></span>
    <div class="headspace-alert-actions">
        <button id="headspace-fine-btn" class="headspace-fine-btn" onclick="HeadspaceBanner.suppress()">I'm fine</button>
        <button id="headspace-dismiss-btn" class="headspace-dismiss-btn" onclick="HeadspaceBanner.dismiss()">&times;</button>
    </div>
</div>

<!-- Headspace Flow Toast (hidden by default) -->
<div id="headspace-flow-toast" class="headspace-flow-toast hidden" role="status" aria-live="polite">
    <span id="headspace-flow-message" class="headspace-flow-text"></span>
</div>

<script>
function toggleMobileMenu() {
    document.getElementById('mobile-menu').classList.toggle('active');
    document.getElementById('mobile-menu-overlay').classList.toggle('active');
    document.querySelector('.hamburger-btn').classList.toggle('active');
}

function closeMobileMenu() {
    document.getElementById('mobile-menu').classList.remove('active');
    document.getElementById('mobile-menu-overlay').classList.remove('active');
    document.querySelector('.hamburger-btn').classList.remove('active');
}

/* Priority-Plus overflow detection */
(function() {
    var hamburgerBtn = document.querySelector('.hamburger-btn');
    var tabGroup = document.querySelector('.tab-btn-group');
    var tabLinks = tabGroup ? tabGroup.querySelectorAll('.tab-link') : [];
    var mobileItems = document.querySelectorAll('.mobile-menu-item[data-nav-key]');
    var resizeTimer;

    function updateOverflowNav() {
        if (!tabGroup || tabLinks.length === 0) return;

        var isMobile = window.matchMedia('(max-width: 768px)').matches;

        if (isMobile) {
            /* At mobile widths, hide all tab links and show all drawer items */
            tabLinks.forEach(function(link) { link.classList.add('overflow-hidden'); });
            mobileItems.forEach(function(item) { item.classList.remove('nav-visible'); });
            hamburgerBtn.classList.add('visible');
            return;
        }

        /* Reset all items first so we can measure accurately */
        tabLinks.forEach(function(link) { link.classList.remove('overflow-hidden'); });

        var containerRect = tabGroup.getBoundingClientRect();
        var anyOverflow = false;

        tabLinks.forEach(function(link) {
            var linkRect = link.getBoundingClientRect();
            /* Item overflows if its right edge exceeds the container's right edge */
            var isOverflowing = linkRect.right > containerRect.right + 1;
            link.classList.toggle('overflow-hidden', isOverflowing);

            /* Mirror to corresponding drawer item */
            var key = link.getAttribute('data-nav-key');
            if (key) {
                var drawerItem = document.querySelector('.mobile-menu-item[data-nav-key="' + key + '"]');
                if (drawerItem) {
                    drawerItem.classList.toggle('nav-visible', !isOverflowing);
                }
            }

            if (isOverflowing) anyOverflow = true;
        });

        hamburgerBtn.classList.toggle('visible', anyOverflow);

        /* If nothing overflows, close the drawer */
        if (!anyOverflow) {
            closeMobileMenu();
        }
    }

    /* Debounced resize handler */
    function onResize() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(updateOverflowNav, 50);
    }

    window.addEventListener('resize', onResize);
    window.addEventListener('load', updateOverflowNav);

    /* Run after fonts load for accurate measurement */
    if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(updateOverflowNav);
    }

    /* Also use ResizeObserver on the tab group for robustness */
    if (typeof ResizeObserver !== 'undefined' && tabGroup) {
        new ResizeObserver(function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(updateOverflowNav, 50);
        }).observe(tabGroup);
    }

    /* Initial run */
    updateOverflowNav();
})();
</script>
