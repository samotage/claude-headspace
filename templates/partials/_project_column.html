<section class="w-full md:w-[480px] md:flex-shrink-0 bg-surface rounded-lg border border-border overflow-hidden flex flex-col"
         data-project-id="{{ project.id }}"
         style="max-height: calc(100vh - 280px);"
         aria-labelledby="project-{{ project.id }}-heading">
    <!-- Column header -->
    <div class="flex items-center justify-between p-4 bg-elevated border-b border-cyan/20"
         style="box-shadow: 0 1px 8px rgba(86,212,221,0.08);">
        <div class="flex items-center gap-3">
            <!-- State indicator dots -->
            <div class="flex items-center gap-1.5">
                <span class="state-dot w-3 h-3 rounded-full bg-red
                    {% if not project.state_flags.has_timed_out %}opacity-25{% endif %}"
                    role="status" aria-label="Timed out"></span>
                <span class="state-dot w-3 h-3 rounded-full bg-amber
                    {% if not project.state_flags.has_input_needed %}opacity-25{% endif %}"
                    role="status" aria-label="Input needed"></span>
                <span class="state-dot w-3 h-3 rounded-full bg-blue
                    {% if not project.state_flags.has_working %}opacity-25{% endif %}"
                    role="status" aria-label="Working"></span>
                <span class="state-dot w-3 h-3 rounded-full bg-green
                    {% if not project.state_flags.has_idle %}opacity-25{% endif %}"
                    role="status" aria-label="Idle"></span>
            </div>

            <!-- Project name + active count -->
            <h2 id="project-{{ project.id }}-heading" class="text-primary font-medium font-display">
                {{ project.name }}
            </h2>
            {% if project.staleness and project.staleness.tier == 'stale' %}
                <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-red/20 text-red">Needs Reboot</span>
            {% elif project.staleness and project.staleness.tier == 'aging' %}
                <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-amber/20 text-amber">Aging</span>
            {% elif project.staleness and project.staleness.tier == 'fresh' %}
                <span class="w-2 h-2 rounded-full bg-green inline-block" title="Fresh"></span>
            {% endif %}
            <span class="text-xs font-mono text-cyan">{{ project.active_count }} active</span>
        </div>

        <!-- Brain Reboot + Progress Summary -->
        <div class="flex items-center gap-1">
            <button class="px-3 py-1 text-xs font-medium rounded border border-purple/30 text-purple hover:bg-purple/10 transition-colors"
                    onclick="openBrainReboot({{ project.id }}, '{{ project.name }}')"
                    title="Generate brain reboot context document">
                Brain Reboot
            </button>
            <button class="progress-summary-btn px-3 py-1 text-xs font-medium rounded border border-cyan/30 text-cyan hover:bg-cyan/10 transition-colors"
                    onclick="toggleProgressSummary({{ project.id }})"
                    data-project-id="{{ project.id }}"
                    title="Generate or view progress summary">
                Headspace
            </button>
        </div>
    </div>

    <!-- Progress Summary panel (hidden by default) -->
    <div id="progress-summary-{{ project.id }}" class="progress-summary-panel hidden border-b border-border bg-deep">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-secondary text-sm font-medium">Progress Summary</span>
                <button class="generate-summary-btn px-2 py-1 text-xs font-medium rounded border border-cyan/30 text-cyan hover:bg-cyan/10 transition-colors"
                        onclick="generateProgressSummary({{ project.id }})"
                        data-project-id="{{ project.id }}">
                    Generate
                </button>
            </div>
            <div class="progress-summary-content text-secondary text-sm" data-project-id="{{ project.id }}">
                <p class="text-muted italic">Click Generate to create a progress summary from git history.</p>
            </div>
        </div>
    </div>

    <!-- Waypoint preview (if available) -->
    {% if project.waypoint %}
    <div class="px-4 py-2 border-b border-border bg-deep flex items-center gap-2">
        <span class="text-muted text-sm">&#9654;</span>
        <span class="text-secondary text-sm truncate flex-1">
            Waypoint: {{ project.waypoint }}
        </span>
        <button class="text-cyan text-sm hover:text-primary min-h-[44px] min-w-[44px] flex items-center justify-center"
                onclick="openWaypointEditor({{ project.id }})"
                aria-label="Edit waypoint for {{ project.name }}">
            [Edit]
        </button>
    </div>
    {% endif %}

    <!-- Agent cards (vertically scrollable) -->
    <div class="p-4 overflow-y-auto flex-1">
        <div class="space-y-4">
            {% for agent in project.agents %}
                {% include "partials/_agent_card.html" %}
            {% endfor %}
        </div>
    </div>
</section>
