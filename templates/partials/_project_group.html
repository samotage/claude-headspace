<section class="bg-surface rounded-lg border border-border overflow-hidden"
         data-project-id="{{ project.id }}"
         aria-labelledby="project-{{ project.id }}-heading">
    <!-- Project header -->
    <div class="flex items-center justify-between p-4 bg-elevated cursor-pointer hover:bg-hover transition-colors min-h-[44px]"
         onclick="this.parentElement.querySelector('.project-content').classList.toggle('hidden')"
         role="button"
         tabindex="0"
         aria-expanded="true"
         aria-controls="project-{{ project.id }}-content"
         onkeypress="if(event.key==='Enter'||event.key===' '){this.click();event.preventDefault();}">

        <div class="flex items-center gap-3">
            <!-- State indicator dots -->
            <div class="flex items-center gap-1.5">
                <span class="state-dot w-3 h-3 rounded-full bg-red
                    {% if not project.state_flags.has_timed_out %}opacity-25{% endif %}"
                    role="status" aria-label="Timed out"></span>
                <span class="state-dot w-3 h-3 rounded-full bg-amber
                    {% if not project.state_flags.has_input_needed %}opacity-25{% endif %}"
                    role="status" aria-label="Input needed"></span>
                <span class="state-dot w-3 h-3 rounded-full bg-blue
                    {% if not project.state_flags.has_working %}opacity-25{% endif %}"
                    role="status" aria-label="Working"></span>
                <span class="state-dot w-3 h-3 rounded-full bg-green
                    {% if not project.state_flags.has_idle %}opacity-25{% endif %}"
                    role="status" aria-label="Idle"></span>
            </div>

            <!-- Project name + staleness -->
            <h2 id="project-{{ project.id }}-heading" class="font-semibold font-display text-xl">
                <a href="/projects/{{ project.slug }}" class="text-cyan hover:text-primary text-glow-cyan transition-colors" onclick="event.stopPropagation()">{{ project.name }}</a>
            </h2>
            {% if project.staleness and project.staleness.tier == 'stale' %}
                <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-red/20 text-red">Needs Reboot</span>
            {% elif project.staleness and project.staleness.tier == 'aging' %}
                <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-amber/20 text-amber">Aging</span>
            {% elif project.staleness and project.staleness.tier == 'fresh' %}
                <span class="w-2 h-2 rounded-full bg-green inline-block" title="Fresh"></span>
            {% endif %}
        </div>

        <!-- Active agent count + actions -->
        <div class="flex flex-col items-end gap-0.5">
            <div class="flex items-center gap-2">
                <button class="px-2 py-0.5 text-xs font-medium rounded border border-cyan/30 text-cyan hover:bg-cyan/10 transition-colors"
                        onclick='event.stopPropagation(); openBrainReboot({{ project.id }}, {{ project.name|tojson }}, {{ project.slug|tojson }})'
                        title="Generate brain reboot context document">
                    Brain Reboot
                </button>
                <span class="text-muted">
                    <svg class="w-4 h-4 transform transition-transform project-chevron"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24"
                         aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </span>
            </div>
            <span class="text-muted text-xs font-mono">
                {{ project.active_count }} active agent{{ 's' if project.active_count != 1 else '' }}
            </span>
        </div>
    </div>

    <!-- Project content (collapsible) -->
    <div id="project-{{ project.id }}-content" class="project-content">
        <!-- Waypoint preview (if available) -->
        {% if project.waypoint %}
        <div class="px-4 py-2 border-t border-border bg-deep flex items-center gap-2">
            <span class="text-muted text-sm">â–¶</span>
            <span class="text-secondary text-sm truncate flex-1">
                Waypoint: {{ project.waypoint }}
            </span>
            <button class="text-cyan text-sm hover:text-primary min-h-[44px] min-w-[44px] flex items-center justify-center"
                    onclick="event.stopPropagation(); openWaypointEditor({{ project.id }})"
                    aria-label="Edit waypoint for {{ project.name }}">
                [Edit]
            </button>
        </div>
        {% endif %}

        <!-- Agent cards grid -->
        <div class="p-4 border-t border-border">
            {% if project.agents %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for agent in project.agents %}
                        {% include "partials/_agent_card.html" %}
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted text-center py-4">No agents in this project.</p>
            {% endif %}
        </div>
    </div>
</section>
