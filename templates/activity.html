{% extends "base.html" %}

{% block title %}Activity - Claude Headspace{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include "partials/_header.html" %}

    <main class="page-content container mx-auto px-4 py-6" role="main">

        <!-- Global Window Toggle + Period Navigation -->
        <div class="flex items-center justify-between mb-6 mt-2">
            <h2 class="text-xs font-semibold text-muted uppercase tracking-wider">Activity</h2>
            <div class="flex items-center gap-4">
                <!-- Period back/forward navigation -->
                <div class="flex items-center gap-1" id="period-nav">
                    <button type="button" id="nav-back"
                            class="w-7 h-7 flex items-center justify-center rounded border border-border text-secondary hover:text-primary hover:border-cyan/30 transition-colors text-sm"
                            onclick="ActivityPage.goBack()">&lsaquo;</button>
                    <span id="period-title" class="text-sm text-primary font-medium min-w-[140px] text-center">Today</span>
                    <button type="button" id="nav-forward"
                            class="w-7 h-7 flex items-center justify-center rounded border border-border text-muted cursor-not-allowed text-sm"
                            onclick="ActivityPage.goForward()" disabled>&rsaquo;</button>
                </div>
                <!-- Day / Week / Month granularity -->
                <div class="flex gap-2" id="window-toggles">
                    <button type="button" data-window="day"
                            class="px-3 py-1 text-sm rounded border border-cyan/30 bg-cyan/20 text-cyan font-medium"
                            onclick="ActivityPage.setWindow('day')">Day</button>
                    <button type="button" data-window="week"
                            class="px-3 py-1 text-sm rounded border border-border text-secondary hover:text-primary hover:border-cyan/30 transition-colors"
                            onclick="ActivityPage.setWindow('week')">Week</button>
                    <button type="button" data-window="month"
                            class="px-3 py-1 text-sm rounded border border-border text-secondary hover:text-primary hover:border-cyan/30 transition-colors"
                            onclick="ActivityPage.setWindow('month')">Month</button>
                </div>
            </div>
        </div>

        <!-- Overall Summary Panel -->
        <section aria-labelledby="overall-heading" class="mb-6">
            <h2 id="overall-heading" class="text-xs font-semibold text-muted uppercase tracking-wider mb-3">Overall</h2>
            <div id="overall-metrics" class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div class="metric-card">
                    <div class="metric-card-value text-cyan text-glow-cyan" id="overall-total-turns">--</div>
                    <div class="metric-card-label" id="overall-total-turns-label">Total Turns</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value text-cyan" id="overall-turn-rate">--</div>
                    <div class="metric-card-label" id="overall-turn-rate-label">Turns / Hour</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value text-amber" id="overall-avg-time">--</div>
                    <div class="metric-card-label">Avg Turn Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value text-green" id="overall-active-agents">--</div>
                    <div class="metric-card-label">Active Agents</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value text-green" id="overall-frustration">--</div>
                    <div class="metric-card-label">Frustration (Immediate)</div>
                </div>
            </div>
            <div id="overall-empty" class="hidden text-center py-4">
                <p class="text-secondary">No activity data yet.</p>
            </div>
        </section>

        <!-- Frustration State Widget -->
        {% if headspace_enabled %}
        <section id="frustration-widget" aria-labelledby="frustration-widget-heading" class="mb-6">
            <h2 id="frustration-widget-heading" class="text-xs font-semibold text-muted uppercase tracking-wider mb-3">Frustration State</h2>
            <div class="grid grid-cols-3 gap-3">
                <div class="frustration-indicator" id="frust-immediate"
                     title="Green: < {{ frustration_thresholds.yellow }} | Yellow: {{ frustration_thresholds.yellow }}-{{ frustration_thresholds.red }} | Red: &ge; {{ frustration_thresholds.red }}">
                    <div class="frustration-indicator-value text-muted" id="frust-immediate-value">&mdash;</div>
                    <div class="frustration-indicator-label">Immediate</div>
                    <div class="frustration-indicator-sublabel">Last 10 turns</div>
                </div>
                <div class="frustration-indicator" id="frust-shortterm"
                     title="Green: < {{ frustration_thresholds.yellow }} | Yellow: {{ frustration_thresholds.yellow }}-{{ frustration_thresholds.red }} | Red: &ge; {{ frustration_thresholds.red }}">
                    <div class="frustration-indicator-value text-muted" id="frust-shortterm-value">&mdash;</div>
                    <div class="frustration-indicator-label">Short-term</div>
                    <div class="frustration-indicator-sublabel">Last 30 min</div>
                </div>
                <div class="frustration-indicator" id="frust-session"
                     title="Green: < {{ frustration_thresholds.yellow }} | Yellow: {{ frustration_thresholds.yellow }}-{{ frustration_thresholds.red }} | Red: &ge; {{ frustration_thresholds.red }}">
                    <div class="frustration-indicator-value text-muted" id="frust-session-value">&mdash;</div>
                    <div class="frustration-indicator-label">Session</div>
                    <div class="frustration-indicator-sublabel">Last {{ session_rolling_window_minutes }} min</div>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Time-Series Chart -->
        <section aria-labelledby="chart-heading" class="mb-6">
            <div class="bg-elevated rounded-lg border border-border p-6">
                <h2 id="chart-heading" class="text-lg font-bold text-primary mb-4">Turn Activity</h2>
                <div class="relative" style="height: 300px;">
                    <canvas id="activity-chart"></canvas>
                </div>
                <div id="chart-empty" class="hidden text-center py-8">
                    <p class="text-secondary">No activity data to chart yet.</p>
                </div>
            </div>
        </section>

        <!-- Project / Agent Metrics -->
        <section aria-labelledby="projects-heading">
            <div class="bg-elevated rounded-lg border border-border p-6">
                <h2 id="projects-heading" class="text-lg font-bold text-primary mb-4">Projects &amp; Agents</h2>
                <div id="project-metrics-container">
                    <!-- Populated by JavaScript -->
                </div>
                <div id="projects-empty" class="hidden text-center py-8">
                    <p class="text-secondary">No project activity data yet.</p>
                </div>
                <div id="projects-loading" class="text-center py-8">
                    <p class="text-muted">Loading metrics...</p>
                </div>
            </div>
        </section>

    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
    window.FRUSTRATION_THRESHOLDS = {
        yellow: {{ frustration_thresholds.yellow }},
        red: {{ frustration_thresholds.red }}
    };
    window.HEADSPACE_ENABLED = {{ headspace_enabled | tojson }};
</script>
<script src="{{ url_for('static', filename='js/activity.js') }}?v={{ cache_bust }}"></script>
{% endblock %}
